# 多国会议数字人播报网站需求文档

## 1. 项目目标
构建一个用于多国会议总结播报的网站系统，支持运营人员在后台对会议总结内容进行导入、编辑与保存；前端使用百度实时互动数字人进行口播，并同步展示会议亮点（Highlight）。

## 2. 角色与使用场景
- 运营人员：在后台创建/导入会议总结，生成口播稿与亮点，并进行编辑保存。
- 访客用户：在前端观看数字人口播会议总结，并查看关键 Highlight。

## 3. 功能范围

### 3.1 后台系统（运营端）
1. 内容录入
- 支持自动导入一条或多条会议总结内容。
- 支持手动新增一条或多条会议总结内容。

2. 基础字段管理
- 每条会议总结必须包含：
  - 标题（title）
  - 时间（meetingTime）
  - 发言人（speaker）
  - 总结原文（summaryRaw）

3. 内容生成
- 基于总结原文自动生成通俗化口播稿（scriptDraft）。
- 自动提取 1-2 条 Highlight（金句/亮点）（highlightsDraft）。

4. Review 编辑区
- 提供完整审核编辑区域，支持对以下内容进行人工修改：
  - 标题
  - 时间
  - 发言人
  - 总结原文
  - 口播稿
  - Highlight
- 支持保存。

### 3.2 前端播报页面（用户端）
1. 数字人播报
- 使用百度实时互动数字人进行口播。
- 播报内容使用后台审核后的最终口播稿（scriptFinal）。

2. Highlight 展示
- 页面同步展示 1-2 条最终 Highlight（highlightsFinal）。

3. 播报状态反馈
- 展示播报中、完成、失败等状态，支持失败提示与重试。

### 3.3 播放页面分层（新增）
1. 数字人调试页（Playback）
- 仅用于调试数字人参数和连接状态。
- 页面保留内容：
  - 数字人画面
  - 数字人参数配置（token、figureId、cameraId、分辨率等）
  - 自动播报队列状态（总条数、当前播报序号）
  - 播报语言多选配置（英文、中文、粤语、日语、印度尼西亚语、马来西亚语、印度语）
  - 打开“沉浸式播放页”按钮
- 页面不再承担口播稿、实时字幕、Highlight 编辑能力。
- 默认播报逻辑：
  - 按列表页中“自动播报=开启”的新闻，依次播报
  - 若选中多种语言，同一条新闻会按语言顺序依次播报，再切换到下一条新闻
  - 播报完最后一条后，从第一条重新开始（循环）
  - 队列来源为 `auto_play_enabled=true` 且 `script_final` 非空的新闻
  - 多语言采用“预处理后播报”：
    - 保存新闻时，后端异步完成多语言翻译并入库
    - 中文/英文使用 `TEXT_RENDER` 文字驱动
    - 其它语言（粤语/日语/印尼语/马来语/印地语）使用预合成 PCM 音频并通过 `AUDIO_STREAM_RENDER` 驱动
    - 若目标语言音频未准备完成，优先等待；若长时间未就绪则回退为同语言文本驱动（不会回退到中文）

2. 沉浸式播放页（Immersive）
- 独立新页面打开，固定 16:9 展示。
- 严格按 `ref/沉浸式新闻播放页.jpg` 的视觉方向实现。
- 页面仅保留两部分：
  - 数字人播报区
  - Highlight（金句）展示区
- 不展示后台调试控件、编辑控件、复杂交互按钮。
- 当前版本按指定新闻进行展示与播报。

## 4. 百度实时互动数字人接入要求

### 4.1 接入方式
- 前端采用 iframe 方式接入百度 H5 数字人页面。

### 4.2 鉴权与安全
- 生产环境必须由后端生成并下发 token（Authorization）给前端。
- 不在前端暴露 appId/appKey。
- token 需具备有效期与刷新机制。

### 4.3 核心参数（示例）
- token
- figureId
- initMode=noAudio
- cameraId
- resolutionWidth / resolutionHeight

### 4.4 关键播报指令
- 单次文本播报：`TEXT_RENDER`
- 流式文本播报（可选）：`TEXT_STREAM_RENDER`
- 音频流播报：`AUDIO_STREAM_RENDER`

### 4.5 关键回调事件
- `RENDER_START`（开始播报）
- `FINISHED`（播报完成）
- `RENDER_ERROR`（播报失败）
- `RENDER_INTERRUPTED`（播报被打断）
- `DOWN_SUBTITLE`（字幕下发）

### 4.6 移动端播放策略
- 为兼容浏览器自动播放策略，需在用户交互后执行解除静音指令（如 `muteAudio=false`）。

## 5. 数据模型（建议）

### 5.1 MeetingReport
- id
- title
- meetingTime
- speaker
- summaryRaw
- scriptDraft
- scriptFinal
- highlightsDraft（数组，1-2 条）
- highlightsFinal（数组，1-2 条）
- status（预留状态字段，当前版本不作为播报条件）
- autoPlayEnabled（boolean，是否进入自动播报队列，默认 false）
- createdAt
- updatedAt
- publishedAt

### 5.2 AvatarConfig
- id
- figureId
- cameraId
- resolutionWidth
- resolutionHeight
- ttsPer（可选，音色）
- ttsLan（可选，语言）
- isActive

## 6. 业务流程
1. 运营导入或手动创建会议总结。
2. 系统生成口播稿草案与 1-2 条 Highlight 草案。
3. 运营在 Review 区编辑并确认最终文案。
4. 运营保存内容并设置是否开启自动播报。
5. 前端拉取自动播报队列并触发百度数字人口播。
6. 播报同时展示 Highlight 与状态信息。
7. 播报使用的标题/Highlight 与当前语言保持一致（同语言展示、同语言播报）。

## 6.1 后台页面交互映射（参考 `ref/News Anchor Dashboard UI`）
1. 列表页（List）
- 字段列：`auto_play_enabled`、`title`、`speaker`、`date`、`actions`
- 操作：`编辑`、`删除`、`新建`、`播放`
- 后端要求：
  - 支持分页查询、按时间倒序
  - 返回总数用于“Showing N items”
  - 支持更新单条新闻 `auto_play_enabled` 字段

2. 编辑页（Editor）
- 左侧输入：
  - `title`（必填）
  - `meeting_time`（非必填）
  - `speaker`（非必填）
  - `summary_raw`（必填）
- 左侧动作：`AI 生成口播稿与亮点`（调用 Azure AI）
- 右侧输出：`script_final`、`highlights_final[1..2]`（均可人工改写）
- 页面动作：`上一条`、`下一条`、`保存`、`保存并开启播报`
- 后端要求：
  - 既支持新建（`/editor`）也支持编辑（`/editor/:id`）
  - 生成动作可多次触发，直接更新当前页面口播稿与亮点
  - 保存时校验：`title`、`summary_raw` 必填

3. 页面路由与后端关系
- `/`：列表接口
- `/editor`：新建接口 + AI 预生成接口 + 保存接口
- `/editor/:id`：详情接口 + 更新接口 + AI 预生成接口
- `/playback`：数字人调试页，默认按自动播报队列循环播报
- `/immersive/{id}`：沉浸式播放页，加载指定新闻

4. 删除策略
- 采用硬删除策略：删除后直接物理删除，不保留回收站数据
- 当前版本不实现“回收站/恢复”

5. 交互参考基线
- 前端交互与布局以 `ref/News Anchor Dashboard UI` 为基准实现
- 后端接口命名和数据结构允许工程化调整，但需保证上述交互完整可用
- 沉浸式播放页视觉以 `ref/沉浸式新闻播放页.jpg` 为强约束
- 百度参数参考以 `ref/云渲染demo (2).zip` 最新内容为准

## 7. 非功能要求
- 稳定性：播报失败可识别并重试。
- 性能：首页加载后可快速初始化数字人容器。
- 安全：鉴权信息不明文暴露在前端代码中。
- 可维护性：后台字段与前端播报字段一一映射，减少手工转换。

## 8. MVP 验收标准
1. 可在后台新增至少 1 条会议总结并保存。
2. 可自动生成口播稿与 2 条 Highlight。
3. 可在编辑页修改并保存。
4. 前端可调用百度数字人按自动播报队列完成循环口播。
5. 前端可同步展示最终 Highlight。
6. 播报状态至少覆盖开始、完成、失败三种可视化反馈。

## 9. 待确认事项
1. 多国会议的语言策略（单语播报/多语切换/同声字幕）。
2. Highlight 是否需要参与数字人口播（当前默认仅展示不播报）。

## 9.1 已确认架构决策（2026-02-11）
1. 状态模型
- 保留 `status` 字段作为后续扩展
- 当前播报逻辑仅依赖 `auto_play_enabled` 与 `script_final`

2. 时区策略
- 系统统一使用中国时区 `Asia/Shanghai`（UTC+08:00）
- 后端入库与接口返回按中国时区处理

3. AI 生成策略
- 仅使用 AI 生成，不实现降级方案
- 生成失败时返回错误并提示人工重试，不提供模板兜底

4. 权限策略
- 当前后台仅 1 人使用，不实现权限系统与角色系统
- 后续若多人协作再补鉴权与角色控制

5. 数据保留策略
- 普通保存数据长期保留
- 删除数据不保留，执行硬删除

6. 浏览器范围
- 当前验收仅覆盖常规浏览器（桌面 Chrome/Edge/Safari）
- 微信内置浏览器暂不纳入本期强制验收

7. 导入策略
- 第一阶段：先做文件导入
- 第二阶段：预留第三方 API 导入能力，后续可直接接入

## 9.2 预留接口方案（导入能力）
1. 文件导入（第一阶段实现）
- `POST /api/reports/import/file`
- 入参：`multipart/form-data`，字段 `file`（CSV/Excel）
- 返回：`success_count`、`failed_count`、`errors[]`

2. API 导入（预留）
- `POST /api/reports/import/source`
- 入参：`source_type`、`source_url`、`auth_config`、`mapping`
- 返回：`task_id`、`accepted_count`
- 说明：先保留契约，后续接任务队列异步拉取

## 10. 阿里云轻量服务器现状（基于 ref 截图）
1. 实例与规格
- 实例名称：`Yoki-adtserver`
- 实例 ID：`7207d619453440e48e834023c0ce9fa9`
- 地域：`华东2（上海）`
- 运行状态：`运行中`
- 镜像：`Ubuntu 22.04`
- 配置：`2 vCPU / 2 GiB / ESSD 40 GiB`
- 峰值公网带宽：`200 Mbps`

2. 网络与域名
- 公网 IP：`47.100.20.107`
- 私网 IP：`172.24.0.89`
- 已配置域名记录：`adty.octaveliving.com`（A 记录，解析状态正常）

## 11. 新增需求：绑定飞书会议链接并导入（2026-02-12）
1. 列表页绑定入口升级
- 列表页“绑定飞书表单”入口升级为“绑定飞书会议链接”。
- 运营输入会议链接（示例：`https://vc.feishu.cn/j/151322082`）后，前端调用后端接口执行导入。
- 也支持输入已录制妙记链接（示例：`https://tpc.feishu.cn/minutes/obcnpo5u16v6e3zhb7y5x59y`）。
- 导入完成后刷新列表，导入结果以“导入成功/更新/失败”给出反馈。
- 兼容“会议进行中”场景：若录制/妙记未生成，系统返回 `pending` 并允许先绑定，前端展示占位实时记录与增量草稿。

2. 后端导入链路
- 新增接口：`POST /api/reports/import/feishu-meeting/diagnose`（按步骤诊断飞书权限链路）
- 新增接口：`POST /api/reports/import/feishu-meeting/inspect`（仅查询飞书会议信息，不入库）
- 新增接口：`POST /api/reports/import/feishu-meeting`
- 入参：
  - `meeting_url`（必填，飞书会议链接）
  - `lookback_days`（可选，默认 30，查询该会议号的时间窗口）
  - `auto_generate`（可选，默认 true，是否自动生成口播稿与 Highlights）
  - `auto_enable_playback`（可选，默认 false，导入后是否自动加入播报队列）
- 返回：
  - `imported_count`、`updated_count`、`failed_count`
  - `items[]`（每条会议实例的处理结果：meeting_no、meeting_id、minute_token、report_id、状态）

3. 飞书接口调用策略
- 会议链接提取 `meeting_no` 后，按以下顺序拉取：
  1) `vc.list_by_no` 获取会议实例（meeting_id）
  2) `vc.meeting-recording.get` 获取 minutes 链接
  3) `minutes.get` 获取妙记基础信息
  4) `minutes.transcript.get` 获取文字记录（txt）
- 若 transcript 暂不可取（例如权限/未就绪），仍导入基础会议信息并记录失败原因。

4. 数据落库策略
- 导入内容写入 `meeting_reports`，并记录来源标识（source_type/source_meeting_no/source_meeting_id/source_minute_token/source_url）。
- 再次导入同一 minute_token 时执行更新，不重复新增。
- 删除策略保持硬删除不变。

5. 与现有播报链路关系
- 导入仅负责“会议信息 -> 新闻数据”入库。
- 若 `auto_generate=true`，导入后自动生成 `script_final + highlights_final + reflections_final`。
- 若 `auto_enable_playback=true`，对应记录自动进入播报队列；否则默认关闭播报开关。
- 当前 HTTPS：`未设置`（需补齐证书与 443 配置）

3. 安全与插件
- 安全防护：`高级版，在线`

## 11. 今日需求变更落地（2026-02-11）
1. 列表页
- 新增 `自动播报` 开关（`auto_play_enabled`），关闭后不进入自动播报队列。
- 操作列保留：`编辑`、`删除`；移除“查看进入调试页”。
- 页面右上角 `播放` 按钮统一跳转调试页 `/playback`。

2. 编辑页
- 页面动作：`上一条`、`下一条`、`保存`、`保存并开启播报`。
- 字段约束：
  - `title` 必填
  - `summary_raw` 必填
  - `meeting_time` 非必填
  - `speaker` 非必填
- 提供 `AI 生成口播稿与亮点` 按钮，生成并回填：
  - `script_final`
  - `highlights_final`（2 条）

3. 数字人调试页
- 默认不加载数字人，用户点击后才加载。
- 保留数字人参数调试能力：`token`、`figureId`、`cameraId`、分辨率等。
- 新增语言多选配置：中文、英文、粤语、日语、印度尼西亚语、马来西亚语、印度语。
- 支持切换“加载/不加载数字人”，不加载时仍可保存语言与队列配置。

4. 沉浸式播报页
- 打开时沿用调试页当前语言选择。
- 若多语言被勾选，播报顺序为：
  - 同一条新闻按语言顺序播完
  - 再切换到下一条新闻
  - 队列循环
- 页面仅展示：数字人 + 2 条 Highlight（16:9 固定）。
- 水印文案：`TPCNEWS`。

5. 多语言播报约束
- 非中文语言先调用 AI 翻译接口准备文案，状态显示 `Pending`。
- 文案未准备完成前不触发播报，避免“先播中文再切语种”的跳变体验。

6. 数据持久化
- 新闻数据写入数据库并持久化。
- 开发环境默认 SQLite，生产环境目标 MySQL 8.x。
- 为避免启动目录导致多库问题，数据库相对路径固定到 `backend/gmwavatar.db`。

## 12. 新一轮交互调整（2026-02-11 晚）
1. 数字人调试页按钮调整
- 参数区将“保存并加载数字人”拆分为两个按钮：
  - `保存配置`
  - `加载数字人（当前调试页）`
- 保留“当前不加载数字人”的默认行为。

2. 沉浸式页面配置读取规则
- 在调试页修改并保存数字人配置后，打开沉浸式页面必须优先读取该最新配置。
- 不允许被旧配置或后端默认配置覆盖。

3. 新闻列表页按钮与字段调整
- 列表页去掉状态展示与状态筛选。
- 顶部保留一个“播放”按钮（进入数字人调试页）。
- 新增“绑定飞书会议链接”按钮：
  - 点击弹出导入面板
  - 输入飞书会议 Link 并绑定
  - 直接导入会议记录为新闻数据（已落地）

4. 自动播报默认策略
- 新建/导入新闻默认 `auto_play_enabled=false`（关闭）。
- 仅当运营手动开启后，才进入自动循环播报队列。

## 13. 第二轮功能细化（2026-02-11 晚）
1. 多语言播报翻译策略（强约束）
- 非中文播报前，必须先通过 Azure AI 完成翻译，并预合成对应语种音频。
- 不允许用原中文文本直接驱动其它语种播报（避免发音与语义错误）。
- 沉浸式页面的新闻标题与 Highlights 也要随当前播报语言同步翻译展示。
- 优化方案：翻译与音频在“保存后”预生成并持久化入库，播放页直接读取，不在播放时临时翻译/临时合成。
- TTS 实现优先使用 Azure Speech（westus2）以提升粤语等语种发音稳定性。

2. 数字人连续播报体验
- 同一播放会话中，数字人实例应持续驻留，不应在每条新闻播报完成后重建或重载。
- 切换到下一条新闻时，仅更新播报文本与展示内容。

3. 播报队列实时同步
- 当列表页切换 `auto_play_enabled` 时，播报队列应立即生效。
- 若沉浸式页面已打开，队列变更后也需自动同步，按新队列继续播报。

4. 编辑页快捷操作
- 新增按钮：`上一条`、`下一条`、`保存并开启播报`。
- 支持在编辑页内快速翻页与保存后直接加入自动播报队列。

5. 列表页 UI 调整
- 去掉列表页顶部 `News Items` 标题区，释放垂直空间用于展示更多新闻条目。
- 命令助手：`已安装`
- 云监控插件：`运行中`（截图中存在“安装中/运行中”状态，当前按最新截图记录为运行中）

4. 生命周期
- 创建时间：`2026-02-11 09:33:09`
- 到期时间：`2026-03-12 00:00:00`
- 备注：需在正式上线前确认续费策略，避免服务中断。

## 14. 新需求规划（2026-02-12，待开发）
1. 编辑页新增多语言切换与预审
- 在新闻编辑页增加语言切换区（中文、英文、粤语、日语、印尼语、马来语、印地语）。
- 当切换到某语言时，系统自动检查该语言是否已完成翻译准备。
- 若未准备，自动触发 AI 翻译并写入翻译表，页面显示“准备中/已准备/失败”状态。
- 运营可在该语言视图下进行人工检查与确认，确保播报前内容已被审核。

2. 调试页新增三种顶层功能模式
- 在数字人调试页顶部新增三按钮模式切换（互斥）：
  - `实时总结`：读取飞书会议实时记录并驱动沉浸式页面展示。
  - `轮播会议总结`：当前已实现的新闻轮播播报模式（默认模式）。
  - `会议反思提问`：选择某条新闻后进入反思问答播报流程。
- 三种模式使用统一调试页框架，但数据源、播报流程和页面展示策略不同。
- 当选择 `实时总结` 模式时，调试页需提供“绑定飞书会议”入口，可输入会议链接并执行诊断/导入。

3. 调试页 UI 调整
- 调试页中的会议主题标题字号调小，降低视觉占比。
- 保持现有数字人参数区与加载控制区不变，新增模式区与模式状态提示区。

4. 模式行为定义
- `实时总结`模式：
  - 数据源：飞书实时会议记录流（后续接入飞书 API/webhook）。
  - 内容优先级：优先展示“章节总结（正式）”，若正式不可读则回退“AI章节纪要（基于逐字稿生成）”，再回退“实时草稿”。
  - 绑定关系：实时模式必须绑定当前会议对应 `report_id`，沉浸式页面只读取该会议数据，不再回退到“最新新闻”。
  - 沉浸式页面展示：实时会议记录、阶段总结、关键要点滚动更新。
  - 数字人策略：静默待机，仅出镜展示，不进行口播。
  - 若当前没有任何章节内容，则前端保持空态，不展示占位假文案。
- `轮播会议总结`模式：
  - 继续沿用当前 `auto_play_enabled` 队列和多语言播报策略。
- `会议反思提问`模式：
  - 选择单条新闻作为上下文，针对该会议生成反思问题与回答草案。
  - 播报策略为“单条深度交互”，不参与队列轮播。

5. 后端能力规划（本轮先规划，不落实现）
- 新增统一模式配置接口，支持前端读取/切换当前调试模式。
- 新增翻译准备状态接口，支持编辑页按语言查询准备状态与触发预翻译。
- 预留飞书实时记录拉取与缓存接口（先定义契约，后续实现）。
- 预留反思问答接口（单条新闻上下文 + AI 反思问答生成）。

6. 验收口径（新需求）
- 编辑页语言切换后，能看到每种语言的准备状态，并可触发自动预翻译。
- 调试页可在三种模式间切换，UI 与状态提示正确。
- 轮播模式不受新模式改动影响，现有播报链路保持可用。
- 实时总结与反思提问模式先完成交互框架与接口占位，后续再接入实数据。

## 15. 本次实现结果（2026-02-12）
1. 编辑页多语言预翻译与校对
- 已新增多语言预翻译勾选区（英文、粤语、日语、印尼语、马来语、印地语）。
- 勾选某语言时，系统会先保存中文主稿，再自动触发该语言翻译准备。
- 已新增语言切换标签：可在中文主稿与已准备语言之间切换查看/编辑。
- 非中文语言支持人工修改翻译标题、口播稿、Highlights，并保存为“已校对”状态。

2. 调试页三模式
- 已新增三种顶层模式按钮：
  - `读取会议实时总结`
  - `轮播会议总结`
  - `会议反思提问`
- 已新增模式持久化接口，调试页与沉浸式页面共享同一模式状态。
- 会议主题字号已下调，避免视觉占比过大。
- 已新增 `保存配置并执行` 按钮：可将调试页当前配置即时推送到沉浸式页面（模式与内容同步）。

3. 模式行为
- `轮播会议总结`：
  - 保持现有多语言队列播报逻辑。
  - 新增“仅播放当前新闻 / 循环播放已开启新闻”切换并持久化。
- `读取会议实时总结`：
  - 已接入实时记录占位数据源接口，可直接读取并展示（数字人静默待机）。
- `会议反思提问`：
  - 支持选择单条新闻并生成 3 组反思问答，再用于播报。

4. 沉浸式页面联动
- 沉浸式页面已改为按后端当前模式自动展示对应内容。
- 轮播模式维持“同新闻多语言播完再切下一条”。
- 实时总结/反思问答模式支持按当前语言切换展示标题与 Highlights（首次会做语言准备）。

5. 本轮新增后端接口
- `GET /api/reports/{id}/translations`
- `POST /api/reports/{id}/translations/{lang}/prepare`
- `PUT /api/reports/{id}/translations/{lang}`
- `POST /api/reports/{id}/reflection`
- `GET /api/playback/mode`
- `PUT /api/playback/mode`
- `GET /api/playback/live-records`

## 16. 新增技术方案（2026-02-13，已对齐）
1. 统一生成链路（会议总结/Highlights/反思）
- 在“有新闻原文或逐字稿”的前提下，统一走 `GeneratePack` 流程，一键产出：
  - `script_final`
  - `highlights_final`（2 条）
  - `reflections_final`（3-5 条）
- 统一做多语言预处理并持久化（标题/口播稿/Highlights/反思）。
- 非中英文继续预合成音频并缓存，播报时不做实时翻译与实时生成。
- 反思模式只读取缓存结果，确保“进入即有数据”。

2. 会后飞书拉齐策略（替代会议中强依赖）
- 在飞书会议进行中，实时接口可能出现 `pending/not_ready/permission_denied`，不作为主链路依赖。
- 改为“会后自动拉齐”：
  - 从多维表读取会议链接（每 5 分钟轮询）
  - 对每条链接执行 `diagnose -> inspect -> import`
  - 状态为 `ready` 时自动写入新闻并触发统一生成链路
- 幂等键顺序：`minute_token` > `meeting_id` > `source_url`。
- 每条链接只维护一条新闻记录，后续只更新不重复创建。

3. 实时展示口径
- 沉浸式实时模式只展示章节类内容：
  - `会议章节总结（正式）`
  - `AI章节纪要（逐字稿生成）`
  - `会议实时草稿`
- 若当前无章节内容，页面保持空态，不展示占位假文案。

4. 多维表接入范围（下一阶段）
- 输入：多维表会议链接列（支持会议链接与妙记链接）。
- 输出：自动新增/更新新闻内容，并自动完成多语言内容准备。
- 后续可扩展字段：来源负责人、业务线、会议类型、优先级。
